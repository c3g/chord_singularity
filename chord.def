Bootstrap: docker
From: python:3.7-slim-stretch

%files
    chord_services.json /chord/chord_services.json
    chord_services.schema.json /chord/chord_services.schema.json
    container_pre_start.py /chord/container_pre_start.py
    container_setup.py /chord/container_setup.py
    LICENSE /chord/LICENSE
    README.rst /chord/README.rst
    requirements.txt /chord/requirements.txt
    start_script.bash /chord/start_script.bash

%post
    apt update && apt install -y nginx git gcc curl
    curl -sL https://deb.nodesource.com/setup_10.x | bash -
    apt install -y nodejs
    export HOME="/chord"
    cd /chord
    git clone --depth 1 https://bitbucket.org/genap/chord_web.git web
    cd /chord/web
    NODE_ENV=development npm install
    NODE_ENV=production npm run build
    mkdir -p /chord/data
    mkdir -p /chord/tmp/nginx
    mkdir /chord/services
    mkdir /chord/vassals
    rm /var/log/nginx/*.log
    touch /chord/tmp/nginx/access.log
    touch /chord/tmp/nginx/error.log
    ln -s /chord/tmp/nginx/access.log /var/log/nginx/access.log
    ln -s /chord/tmp/nginx/error.log /var/log/nginx/error.log
    pip3 install --no-cache-dir virtualenv
    pip3 install --no-cache-dir -r /chord/requirements.txt
    cd /chord
    python3.7 ./container_setup.py ./chord_services.json
    rm -rf /chord/.cache
    apt purge -y git gcc curl
    apt autoremove -y

%startscript
    exec bash /chord/start_script.bash

%labels
    Author David Lougheed
